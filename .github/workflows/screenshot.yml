name: OpenRouter Rankings Screenshot

on:
  workflow_dispatch:  # 只允许手动触发

jobs:
  screenshot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium

      # 截取 https://openrouter.ai/rankings 页面截图
      - name: Take OpenRouter rankings screenshot
        run: |
          echo "const { chromium } = require('playwright');" > script_rankings.js
          echo "(async () => {" >> script_rankings.js
          echo "  const browser = await chromium.launch();" >> script_rankings.js
          echo "  const page = await browser.newPage({ viewport: { width: 1440, height: 900 } });" >> script_rankings.js
          echo "  await page.goto('https://openrouter.ai/rankings', { waitUntil: 'networkidle', timeout: 60000 });" >> script_rankings.js
          echo "  const showMore = page.locator('text=Show more');" >> script_rankings.js
          echo "  if (await showMore.count() > 0) {" >> script_rankings.js
          echo "    await showMore.first().click();" >> script_rankings.js
          echo "    await page.waitForTimeout(3000);" >> script_rankings.js
          echo "  }" >> script_rankings.js
          echo "  const rankingsSection = page.locator('main');" >> script_rankings.js
          echo "  await rankingsSection.waitFor({ timeout: 10000 });" >> script_rankings.js
          echo "  const date = new Date().toISOString().slice(0, 10);" >> script_rankings.js
          echo "  await rankingsSection.screenshot({ path: \`openrouter_ranking_\${date}.png\` });" >> script_rankings.js
          echo "  await browser.close();" >> script_rankings.js
          echo "})();" >> script_rankings.js
          node script_rankings.js

      # 截取 https://openrouter.ai/kwaipilot/kat-coder-pro:free/apps 页面截图
      - name: Take Kwaipilot Kat-Coder-Pro screenshot
        run: |
          echo "const { chromium } = require('playwright');" > script_kat_coder.js
          echo "(async () => {" >> script_kat_coder.js
          echo "  const browser = await chromium.launch();" >> script_kat_coder.js
          echo "  const page = await browser.newPage({ viewport: { width: 1440, height: 900 } });" >> script_kat_coder.js
          echo "  await page.goto('https://openrouter.ai/kwaipilot/kat-coder-pro:free/apps', { waitUntil: 'networkidle', timeout: 60000 });" >> script_kat_coder.js
          echo "  const showMore = page.locator('text=Show more');" >> script_kat_coder.js
          echo "  if (await showMore.count() > 0) {" >> script_kat_coder.js
          echo "    await showMore.first().click();" >> script_kat_coder.js
          echo "    await page.waitForTimeout(3000);" >> script_kat_coder.js
          echo "  }" >> script_kat_coder.js
          echo "  const katCoderSection = page.locator('main');" >> script_kat_coder.js
          echo "  await katCoderSection.waitFor({ timeout: 10000 });" >> script_kat_coder.js
          echo "  const date = new Date().toISOString().slice(0, 10);" >> script_kat_coder.js
          echo "  await katCoderSection.screenshot({ path: \`kat_coder_screenshot_\${date}.png\` });" >> script_kat_coder.js
          echo "  await browser.close();" >> script_kat_coder.js
          echo "})();" >> script_kat_coder.js
          node script_kat_coder.js

      # 获取当前日期，格式为 yyyy-mm-dd
      - name: Get current date
        id: current_date
        run: echo "DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      # 创建包含日期的 ZIP 文件
      - name: Zip screenshots with date
        run: |
          zip screenshots_${{ env.DATE }}.zip openrouter_ranking_*.png kat_coder_screenshot_*.png

      # 上传两个截图作为 artifact
      - name: Upload screenshots as artifact
        uses: actions/upload-artifact@v4
        with:
          name: openrouter-ranking-and-kat-coder
          path: screenshots_${{ env.DATE }}.zip

      # 发送 ZIP 文件作为附件到邮箱
      - name: Send ZIP file by email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}  # 你的 Gmail 地址
          password: ${{ secrets.EMAIL_PASSWORD }}  # 你的 Gmail 应用专用密码
          subject: OpenRouter Rankings & Kwaipilot Kat-Coder-Pro Screenshots
          body: |
            Hi,

            Attached is a ZIP file containing the latest OpenRouter rankings and Kwaipilot Kat-Coder-Pro screenshots.

            This email was sent automatically.

            Best regards,
            Your GitHub automation bot
          to: ${{ secrets.EMAIL_TO }}  # 目标邮箱地址
          from: OpenRouter Bot <${{ secrets.EMAIL_USERNAME }}>
          attachments: screenshots_${{ env.DATE }}.zip  # 发送带日期的 ZIP 文件
